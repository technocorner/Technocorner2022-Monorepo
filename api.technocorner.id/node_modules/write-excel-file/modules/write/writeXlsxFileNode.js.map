{"version":3,"sources":["../../source/write/writeXlsxFileNode.js"],"names":["fs","path","os","Archive","generateWorkbookXml","generateWorkbookXmlRels","rels","contentTypes","generateSheets","writeXlsxFile","data","filePath","sheetName","sheet","sheetNames","sheets","schema","columns","headerStyle","fontFamily","fontSize","orientation","stickyRowsCount","stickyColumnsCount","dateFormat","archive","getSharedStringsXml","getStylesXml","createTempDirectory","root","createDirectory","join","xl","_rels","worksheetsPath","promises","writeFile","id","push","Promise","all","directory","append","write","removeDirectory","contents","resolve","reject","error","mkdir","mkdtemp","tmpdir","directoryPath","rmdir","recursive"],"mappings":";;;;;;;;;AAAA,OAAOA,EAAP,MAAe,IAAf;AACA,OAAOC,IAAP,MAAiB,MAAjB;AACA,OAAOC,EAAP,MAAe,IAAf;AAEA,OAAOC,OAAP,MAAoB,WAApB;AAEA,OAAOC,mBAAP,MAAgC,wBAAhC;AACA,OAAOC,uBAAP,MAAoC,6BAApC;AACA,OAAOC,IAAP,MAAiB,gBAAjB;AACA,OAAOC,YAAP,MAAyB,+BAAzB;AAEA,SAASC,cAAT,QAA+B,wBAA/B;AAEA,wBAA8BC,aAA9B;AAAA;AAAA;;;4EAAe,iBAA6BC,IAA7B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,2EAaX,EAbW,EACdC,QADc,QACdA,QADc,EAEPC,SAFO,QAEdC,KAFc,EAGNC,UAHM,QAGdC,MAHc,EAIdC,MAJc,QAIdA,MAJc,EAKdC,OALc,QAKdA,OALc,EAMdC,WANc,QAMdA,WANc,EAOdC,UAPc,QAOdA,UAPc,EAQdC,QARc,QAQdA,QARc,EASdC,WATc,QASdA,WATc,EAUdC,eAVc,QAUdA,eAVc,EAWdC,kBAXc,QAWdA,kBAXc,EAYdC,UAZc,QAYdA,UAZc;AAcRC,YAAAA,OAdQ,GAcE,IAAItB,OAAJ,CAAYQ,QAAZ,CAdF;AAAA,8BAoBVH,cAAc,CAAC;AAClBE,cAAAA,IAAI,EAAJA,IADkB;AAElBE,cAAAA,SAAS,EAATA,SAFkB;AAGlBE,cAAAA,UAAU,EAAVA,UAHkB;AAIlBE,cAAAA,MAAM,EAANA,MAJkB;AAKlBC,cAAAA,OAAO,EAAPA,OALkB;AAMlBC,cAAAA,WAAW,EAAXA,WANkB;AAOlBC,cAAAA,UAAU,EAAVA,UAPkB;AAQlBC,cAAAA,QAAQ,EAARA,QARkB;AASlBC,cAAAA,WAAW,EAAXA,WATkB;AAUlBC,cAAAA,eAAe,EAAfA,eAVkB;AAWlBC,cAAAA,kBAAkB,EAAlBA,kBAXkB;AAYlBC,cAAAA,UAAU,EAAVA;AAZkB,aAAD,CApBJ,EAiBbT,MAjBa,mBAiBbA,MAjBa,EAkBbW,mBAlBa,mBAkBbA,mBAlBa,EAmBbC,YAnBa,mBAmBbA,YAnBa,EAmCd;AACA;AACA;;AArCc;AAAA,mBAsCKC,mBAAmB,EAtCxB;;AAAA;AAsCRC,YAAAA,IAtCQ;AAAA;AAAA,mBAuCGC,eAAe,CAAC7B,IAAI,CAAC8B,IAAL,CAAUF,IAAV,EAAgB,IAAhB,CAAD,CAvClB;;AAAA;AAuCRG,YAAAA,EAvCQ;AAAA;AAAA,mBAwCMF,eAAe,CAAC7B,IAAI,CAAC8B,IAAL,CAAUC,EAAV,EAAc,OAAd,CAAD,CAxCrB;;AAAA;AAwCRC,YAAAA,KAxCQ;AAAA;AAAA,mBAyCeH,eAAe,CAAC7B,IAAI,CAAC8B,IAAL,CAAUC,EAAV,EAAc,YAAd,CAAD,CAzC9B;;AAAA;AAyCRE,YAAAA,cAzCQ;AA2CRC,YAAAA,QA3CQ,GA2CG,CAChBC,SAAS,CAACnC,IAAI,CAAC8B,IAAL,CAAUE,KAAV,EAAiB,mBAAjB,CAAD,EAAwC5B,uBAAuB,CAAC;AAAEU,cAAAA,MAAM,EAANA;AAAF,aAAD,CAA/D,CADO,EAEhBqB,SAAS,CAACnC,IAAI,CAAC8B,IAAL,CAAUC,EAAV,EAAc,cAAd,CAAD,EAAgC5B,mBAAmB,CAAC;AAAEW,cAAAA,MAAM,EAANA;AAAF,aAAD,CAAnD,CAFO,EAGhBqB,SAAS,CAACnC,IAAI,CAAC8B,IAAL,CAAUC,EAAV,EAAc,YAAd,CAAD,EAA8BL,YAAY,EAA1C,CAHO,EAIhBS,SAAS,CAACnC,IAAI,CAAC8B,IAAL,CAAUC,EAAV,EAAc,mBAAd,CAAD,EAAqCN,mBAAmB,EAAxD,CAJO,CA3CH;;AAkDd,6DAA2BX,MAA3B,iCAAmC;AAAA,yCAAtBsB,EAAsB,eAAtBA,EAAsB,EAAlB3B,KAAkB,eAAlBA,IAAkB;AAClCyB,cAAAA,QAAQ,CAACG,IAAT,CAAcF,SAAS,CAACnC,IAAI,CAAC8B,IAAL,CAAUG,cAAV,iBAAkCG,EAAlC,UAAD,EAA8C3B,KAA9C,CAAvB;AACA;;AApDa;AAAA,mBAsDR6B,OAAO,CAACC,GAAR,CAAYL,QAAZ,CAtDQ;;AAAA;AAwDdV,YAAAA,OAAO,CAACgB,SAAR,CAAkBT,EAAlB,EAAsB,IAAtB;AACAP,YAAAA,OAAO,CAACiB,MAAR,CAAepC,IAAf,EAAqB,aAArB;AACAmB,YAAAA,OAAO,CAACiB,MAAR,CAAenC,YAAf,EAA6B,qBAA7B;;AA1Dc,iBA4DVI,QA5DU;AAAA;AAAA;AAAA;;AAAA;AAAA,mBA6DPc,OAAO,CAACkB,KAAR,EA7DO;;AAAA;AAAA;AAAA,mBA8DPC,eAAe,CAACf,IAAD,CA9DR;;AAAA;AAAA;AAAA;;AAAA;AAAA,6CAgENJ,OAAO,CAACkB,KAAR,EAhEM;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAoEf,SAASP,SAAT,CAAmBnC,IAAnB,EAAyB4C,QAAzB,EAAmC;AAClC,SAAO,IAAIN,OAAJ,CAAY,UAACO,OAAD,EAAUC,MAAV,EAAqB;AACvC/C,IAAAA,EAAE,CAACoC,SAAH,CAAanC,IAAb,EAAmB4C,QAAnB,EAA6B,OAA7B,EAAsC,UAACG,KAAD,EAAW;AAChD,UAAIA,KAAJ,EAAW;AACV,eAAOD,MAAM,CAACC,KAAD,CAAb;AACA;;AACDF,MAAAA,OAAO;AACP,KALD;AAMA,GAPM,CAAP;AAQA;;AAED,SAAShB,eAAT,CAAyB7B,IAAzB,EAA+B;AAC9B,SAAO,IAAIsC,OAAJ,CAAY,UAACO,OAAD,EAAUC,MAAV,EAAqB;AACvC/C,IAAAA,EAAE,CAACiD,KAAH,CAAShD,IAAT,EAAe,UAAC+C,KAAD,EAAW;AACzB,UAAIA,KAAJ,EAAW;AACV,eAAOD,MAAM,CAACC,KAAD,CAAb;AACA;;AACDF,MAAAA,OAAO,CAAC7C,IAAD,CAAP;AACA,KALD;AAMA,GAPM,CAAP;AAQA;;AAED,SAAS2B,mBAAT,GAA+B;AAC9B,SAAO,IAAIW,OAAJ,CAAY,UAACO,OAAD,EAAUC,MAAV,EAAqB;AACvC/C,IAAAA,EAAE,CAACkD,OAAH,CAAWjD,IAAI,CAAC8B,IAAL,CAAU7B,EAAE,CAACiD,MAAH,EAAV,EAAuB,mBAAvB,CAAX,EAAwD,UAACH,KAAD,EAAQI,aAAR,EAA0B;AACjF,UAAIJ,KAAJ,EAAW;AACV,eAAOD,MAAM,CAACC,KAAD,CAAb;AACA;;AACDF,MAAAA,OAAO,CAACM,aAAD,CAAP;AACA,KALD;AAMA,GAPM,CAAP;AAQA;;AAED,SAASR,eAAT,CAAyB3C,IAAzB,EAA+B;AAC9B,SAAO,IAAIsC,OAAJ,CAAY,UAACO,OAAD,EAAUC,MAAV,EAAqB;AACvC/C,IAAAA,EAAE,CAACqD,KAAH,CAASpD,IAAT,EAAe;AAAEqD,MAAAA,SAAS,EAAE;AAAb,KAAf,EAAoC,UAACN,KAAD,EAAW;AAC9C,UAAIA,KAAJ,EAAW;AACV,eAAOD,MAAM,CAACC,KAAD,CAAb;AACA;;AACDF,MAAAA,OAAO,CAAC7C,IAAD,CAAP;AACA,KALD;AAMA,GAPM,CAAP;AAQA","sourcesContent":["import fs from 'fs'\r\nimport path from 'path'\r\nimport os from 'os'\r\n\r\nimport Archive from './archive'\r\n\r\nimport generateWorkbookXml from './statics/workbook.xml'\r\nimport generateWorkbookXmlRels from './statics/workbook.xml.rels'\r\nimport rels from './statics/rels'\r\nimport contentTypes from './statics/[Content_Types].xml'\r\n\r\nimport { generateSheets } from './writeXlsxFile.common'\r\n\r\nexport default async function writeXlsxFile(data, {\r\n\tfilePath,\r\n\tsheet: sheetName,\r\n\tsheets: sheetNames,\r\n\tschema,\r\n\tcolumns,\r\n\theaderStyle,\r\n\tfontFamily,\r\n\tfontSize,\r\n\torientation,\r\n\tstickyRowsCount,\r\n\tstickyColumnsCount,\r\n\tdateFormat\r\n} = {}) {\r\n\tconst archive = new Archive(filePath)\r\n\r\n\tconst {\r\n\t\tsheets,\r\n\t\tgetSharedStringsXml,\r\n\t\tgetStylesXml\r\n\t} = generateSheets({\r\n\t\tdata,\r\n\t\tsheetName,\r\n\t\tsheetNames,\r\n\t\tschema,\r\n\t\tcolumns,\r\n\t\theaderStyle,\r\n\t\tfontFamily,\r\n\t\tfontSize,\r\n\t\torientation,\r\n\t\tstickyRowsCount,\r\n\t\tstickyColumnsCount,\r\n\t\tdateFormat\r\n\t})\r\n\r\n\t// There doesn't seem to be a way to just append a file into a subdirectory\r\n\t// in `archiver` library, hence using a hacky temporary directory workaround.\r\n\t// https://www.npmjs.com/package/archiver\r\n\tconst root = await createTempDirectory()\r\n\tconst xl = await createDirectory(path.join(root, 'xl'))\r\n\tconst _rels = await createDirectory(path.join(xl, '_rels'))\r\n\tconst worksheetsPath = await createDirectory(path.join(xl, 'worksheets'))\r\n\r\n\tconst promises = [\r\n\t\twriteFile(path.join(_rels, 'workbook.xml.rels'), generateWorkbookXmlRels({ sheets })),\r\n\t\twriteFile(path.join(xl, 'workbook.xml'), generateWorkbookXml({ sheets })),\r\n\t\twriteFile(path.join(xl, 'styles.xml'), getStylesXml()),\r\n\t\twriteFile(path.join(xl, 'sharedStrings.xml'), getSharedStringsXml())\r\n\t]\r\n\r\n\tfor (const { id, data } of sheets) {\r\n\t\tpromises.push(writeFile(path.join(worksheetsPath, `sheet${id}.xml`), data))\r\n\t}\r\n\r\n\tawait Promise.all(promises)\r\n\r\n\tarchive.directory(xl, 'xl')\r\n\tarchive.append(rels, '_rels/.rels')\r\n\tarchive.append(contentTypes, '[Content_Types].xml')\r\n\r\n\tif (filePath) {\r\n\t\tawait archive.write()\r\n\t\tawait removeDirectory(root)\r\n\t} else {\r\n\t\treturn archive.write()\r\n\t}\r\n}\r\n\r\nfunction writeFile(path, contents) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.writeFile(path, contents, 'utf-8', (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve()\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction createDirectory(path) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.mkdir(path, (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(path)\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction createTempDirectory() {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.mkdtemp(path.join(os.tmpdir(), 'write-excel-file-'), (error, directoryPath) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(directoryPath)\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction removeDirectory(path) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.rmdir(path, { recursive: true }, (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(path)\r\n\t\t})\r\n\t})\r\n}"],"file":"writeXlsxFileNode.js"}